<!-- build configuration -->
<project name="build-support">

  <!-- define the location of our subprojects in relation to the top-level -->
  <property name="project.dir" value="projects"/>

  <!-- specify where we'll find our various dependencies -->
  <property name="extlib.dir" value="lib"/>
  <property name="libs.dir"   value="${deploy.dir}/lib"/>

  <!-- we want some tasks from ant-contrib -->
  <taskdef resource="net/sf/antcontrib/antlib.xml">
    <classpath>
      <pathelement location="${extlib.dir}/ant-contrib.jar"/>
    </classpath>
  </taskdef>

  <!-- call buildproject on each item in ${webapps} -->
  <target name="webapps">
    <antcall target="distprojects">
      <param name="projects"  value="${webapps}"/>
    </antcall>
  </target>

  <!-- call buildproject on each item in ${projects} -->
  <target name="distprojects">
    <if><not><isset property="dest.dir"/></not>
      <then>
        <property name="dest.dir" value="${deploy.dir}/lib"/>
      </then>
    </if>
    <for list="${projects}" param="project">
      <sequential>
        <antcall target="buildproject">
          <param name="project"  value="@{project}"/>
        </antcall>
        <!-- copy the library jars to ${deploy.dir}/lib -->
        <antcall target="copyresult">
          <param name="project"  value="@{project}"/>
          <param name="dest.dir" value="${dest.dir}"/>
        </antcall>
      </sequential>
    </for>
  </target>

  <!-- builds a project in ${project.dir}/${project} -->
  <target name="buildproject">
    <echo>Building in ${project}...</echo>
    <ant dir="${project.dir}/${project}" target="dist" inheritAll="false">
      <property name="libs.dir" value="../../${libs.dir}"/>
    </ant>
  </target>

  <!-- convenience target that copies ${project.dir}/[projects]/dist/*.jar to ${deploy.dir}/lib -->
  <target name="copyresults">
    <for list="${projects}" param="project">
      <sequential>
        <antcall target="copyresult">
          <param name="project"  value="@{project}"/>
          <param name="dest.dir" value="${deploy.dir}/lib"/>
        </antcall>
      </sequential>
    </for>
  </target>

  <!-- copy the project results to ${dest.dir} -->
  <target name="copyresult">
    <copy todir="${dest.dir}">
      <fileset dir="${project.dir}/${project}/dist">
        <include name="*.jar"/>
      </fileset>
    </copy>
  </target>

  <!-- call cleanproject on each item in ${projects} -->
  <target name="cleanprojects">
    <if><isset property="webapps"/>
      <then>
        <property name="projects.list" value="${projects},${webapps}"/>
      </then>
      <else>
        <property name="projects.list" value="${projects}"/>
      </else>
    </if>
    <for list="${projects.list}" param="project">
      <sequential>
        <antcall target="cleanproject">
          <param name="project"  value="@{project}"/>
        </antcall>
      </sequential>
    </for>
  </target>

  <!-- cleans the project in ${project.dir}/${project} -->
  <target name="cleanproject">
    <echo level="info">Cleaning in ${project}...</echo>
    <ant dir="${project.dir}/${project}" 
         target="distclean" inheritAll="false"/>
  </target>

  <!-- copies the dist.libs fileset into deploy.dir/lib -->
  <target name="copydistlibs">
    <copy todir="${deploy.dir}/lib" flatten="true">
      <fileset refid="dist.libs"/>
    </copy>
  </target>

</project>
