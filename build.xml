<!-- project build configuration -->
<project name="Game Gardens Server" default="all" basedir=".">

  <!-- load up our configuration information -->
  <property file="toybox.properties"/>

  <!-- things you probably don't want to change -->
  <property name="deploy.dir" value="dist"/>

  <!-- declare our subprojects and webapps -->
  <import file="etc/build-support.xml"/>
  <property name="projects" value="samskivert,narya,nenya,vilya,toybox"/>
  <property name="webapps"  value="gardens"/>

  <!-- declare the libraries needed by the main thing -->
  <fileset dir="." id="dist.libs">
    <include name="${extlib.dir}/ant.jar"/>
    <include name="${extlib.dir}/activation.jar"/>
    <include name="${extlib.dir}/commons-beanutils.jar"/>
    <include name="${extlib.dir}/commons-collections.jar"/>
    <include name="${extlib.dir}/commons-digester.jar"/>
    <include name="${extlib.dir}/commons-fileupload-1.0.jar"/>
    <include name="${extlib.dir}/commons-io.jar"/>
    <include name="${extlib.dir}/commons-lang.jar"/>
    <include name="${extlib.dir}/commons-logging.jar"/>
    <include name="${extlib.dir}/getdown.jar"/>
    <include name="${extlib.dir}/mail.jar"/>
    <include name="${extlib.dir}/mysql-connector-java-3.0.11-stable-bin.jar"/>
    <include name="${extlib.dir}/servlet-2.3.jar"/>
    <include name="${extlib.dir}/velocity-1.5-dev.jar"/>
    <include name="${extlib.dir}/threerings.jar"/> <!-- optional -->
    <include name="${libs.dir}/narya-base.jar"/>
    <include name="${libs.dir}/narya-distrib.jar"/>
    <include name="${libs.dir}/nenya-media.jar"/>
    <include name="${libs.dir}/nenya-rsrc.jar"/>
    <include name="${libs.dir}/samskivert.jar"/>
    <include name="${libs.dir}/vilya-micasa.jar"/>
    <include name="${libs.dir}/vilya-parlor.jar"/>
  </fileset>

  <!-- creates the Proguarded Java client -->
  <target name="client" depends="copydistlibs">
    <ant dir="projects/client" target="all" inheritAll="false"/>
  </target>

  <!-- signs the server jar files -->
  <target name="sign">
    <!-- copy any updated jar files into the seclib directory -->
    <mkdir dir="seclib"/>
    <copy todir="seclib">
      <fileset dir="${deploy.dir}/lib" includes="*.jar"/>
    </copy>

    <!-- now sign them -->
    <if><isset property="sign.alias"/><then>
      <signjar lazy="true" alias="${sign.alias}" keystore="${sign.keystore}"
               storepass="${sign.storepass}">
        <fileset dir="seclib" includes="*.jar"/>
      </signjar>
    </then><else>
      <echo>Not signing server code. No keystore configured.</echo>
    </else></if>
  </target>

  <!-- the default target is to install and sign the client -->
  <target name="all" depends="sign"/>

  <!-- ensures that a toybox.properties exists -->
  <target name="prepare" depends="copydistlibs">
    <if><not><isset property="webapp_dir"/></not>
    <then>
      <echo>Generating default toybox.properties.</echo>
      <copy tofile="toybox.properties" file="toybox.properties.dist"/>
    </then>
    </if>
  </target>

  <!-- rebuilds all subprojects and the top-level application -->
  <target name="distall" depends="prepare,distprojects,webapps,client"/>

  <!-- fully cleans out the installed application and all subprojects -->
  <target name="cleanall" depends="cleanprojects">
    <ant dir="projects/client" target="clean" inheritAll="false"/>
    <delete dir="${deploy.dir}"/>
  </target>
</project>
