#!/bin/sh
#
# $Id: generic-mysqld 270 2005-02-02 02:14:48Z mdb $
#
# Startup script for the database server.

# Locate our gardens directory
GARDENS_HOME=`dirname $0 | sed s:/bin$::`
if [ ! -f $GARDENS_HOME/gardens.conf ]; then
    # If we are run from /etc/init.d we must assume /export/gardens
    GARDENS_HOME=/export/gardens
fi
if [ ! -f $GARDENS_HOME/gardens.conf ]; then
    echo "Unable to infer GARDENS_HOME. No /export/gardens directory?"
    exit 1
fi

# The user as which mysql will run
MYSQL_USER=mysql

# Read in our configuration
. $GARDENS_HOME/gardens.conf

# Find out if we're starting the master or slave
WHICH=$1
if [ -z "$WHICH" ]; then
    echo "First argument must be 'master' or 'slave'."
    exit -1
fi

shift
MYCNF=$GARDENS_HOME/etc/mysql-$WHICH.cnf
if [ ! -f $MYCNF ]; then
    echo "Unable to locate configuration file: $MYCNF"
    exit -1
fi

DAEMON=/usr/bin/mysqld_safe
if [ ! -x $DAEMON ]; then
    DAEMON=/usr/local/bin/mysqld_safe
fi
if [ ! -x $DAEMON ]; then
    echo "Unable to locate 'mysql_safe' binary."
    exit -1
fi
PIDFILE=`grep pid-file $MYCNF | awk -F= '{ print $2 }' | sed 's: ::g'`
ERRFILE=`grep err-log $MYCNF | awk -F= '{ print $2 }' | sed 's: ::g'`

# See how we were called
case "$1" in
  start)
        # Make sure mysqld is not currently running
	if [ -f $PIDFILE ]; then
	    echo "mysqld appears to be already running."
            echo "Run '$0 stop' to stop it first."
	    exit 1
	fi
        # Make sure our unix domain socket directory exists
        if [ ! -d /var/run/mysqld ]; then
            mkdir /var/run/mysqld
            chown $MYSQL_USER /var/run/mysqld
        fi
        # Make sure our log files exist
        touch $ERRFILE
        chown $MYSQL_USER $ERRFILE
        # Make sure our data directory and its contents are
        # properly permissioned
        chown -R $MYSQL_USER $GARDENS_HOME/data/mysql
        # Go ahead and start things up
        echo -n "Starting $DAEMON: "
        $DAEMON --defaults-file=$MYCNF \
            --default-character-set=utf8 \
            --default-collation=utf8_general_ci \
            >>$ERRFILE 2>&1 &
        echo "started."
        ;;

  stop)
	if [ ! -f $PIDFILE ]; then
	    echo "No $PIDFILE exists. Is mysqld running?"
	    exit 1
	fi
        echo -n "Shutting down mysqld: "
        kill `cat $PIDFILE`
        echo "stopped."
        rm -f $PIDFILE
        ;;

  restart)
	echo "Not implemented."
        exit 1
        ;;

  *)
        echo "Usage: $0 {start|stop|restart}"
        exit 1
esac

exit 0
