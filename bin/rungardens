#!/bin/sh
#
# $Id: rungardens 260 2004-12-03 17:55:21Z mdb $
#
# A script to invoke the Game Gardens server and archive the generated
# logs when it eventually exits.

NAME=gardens
DESC="Gardens game server"

GARDENS_HOME=`dirname $0`/..
GARDENS_HOME=`echo $GARDENS_HOME | sed 's:/bin/..::g'`
LOGFILE=$GARDENS_HOME/log/gardens.log

# Load settings with those from gardens.conf
if [ -f $GARDENS_HOME/gardens.conf ]; then
    . $GARDENS_HOME/gardens.conf
else
    echo "Can't load '$GARDENS_HOME/gardens.conf'; can't run server."
    exit 255
fi

CLASS=com.threerings.toybox.server.ToyBoxServer
JAVA_ARGS="-server -Dlog_level=$LOGLEVEL"
SECURITY_POLICY="$GARDENS_HOME/etc/gardens.policy"
if [ -f $SECURITY_POLICY ]; then
    JAVA_ARGS="$JAVA_ARG5BS -Djava.security.manager"
    JAVA_ARGS="$JAVA_ARGS -Djava.security.policy=$SECURITY_POLICY"
fi
umask 002

JAVA_VM="$JAVA_HOME/bin/java"
if [ ! -e $JAVA_VM ]; then
    echo "$0: Cannot find JVM in $JAVA_HOME. Exiting."
    exit 255
fi

# Start with the standard Java classes
CLASSPATH="$JAVA_HOME/jre/lib/rt.jar"

# Add all JAR files in $GARDENS_HOME/seclib to the CLASSPATH
for jar in $GARDENS_HOME/dist/lib/*.jar; do
    if [ -e $jar ]; then
        CLASSPATH=$jar:$CLASSPATH
    fi
done

# Add toybox to the class path
CLASSPATH=$GARDENS_HOME/dist/toybox.jar:$CLASSPATH

# Add the deployment directory directory to the CLASSPATH for properties
# and toybox.jar
CLASSPATH=$GARDENS_HOME/dist:$CLASSPATH
export CLASSPATH

# Set up the LD_LIBRARY_PATH to include our shared libraries
LD_LIBRARY_PATH=$GARDENS_HOME/dist/lib/`uname -m`-`uname -s`
export LD_LIBRARY_PATH

# Start up the server
touch $LOGFILE
WHOAMI=`whoami`
if [ "$WHOAMI" = "root" ]; then
    chown $GARDENS_USER $LOGFILE
    chmod u+rw $LOGFILE
    su $GARDENS_USER
elif [ "$WHOAMI" != "$GARDENS_USER" ]; then
    echo "$0: Running as $WHOAMI rather than $GARDENS_USER."
fi

echo "Running Game Gardens server:" >>$LOGFILE
echo "    Gardens root: $GARDENS_HOME" >>$LOGFILE
echo "         Java VM: $JAVA_VM" >>$LOGFILE
echo "       Java args: $JAVA_ARGS" >>$LOGFILE
echo "    Server class: $CLASS" >>$LOGFILE

$JAVA_VM $JAVA_ARGS $CLASS >>$LOGFILE 2>&1
EXIT_CODE=$?

# Archive the server log
NOW=`date "+%F-%H:%M"`
mv $LOGFILE $LOGFILE.$NOW

# Prune old logs
find $GARDENS_HOME/log -name 'gardens.log*' -a -mtime +7 | xargs rm -f

exit $EXIT_CODE
