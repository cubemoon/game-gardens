#!/bin/sh
#
# $Id: gardens 255 2004-11-19 01:48:22Z mdb $
#
# Startup script for the Game Gardens game server. Currently works on
# Debian and Redhat 9.

# Locate our ocean directory
GARDENS_HOME=`dirname $0`/..
GARDENS_HOME=`echo $GARDENS_HOME | sed 's:/bin/..::g'`
if [ ! -f $GARDENS_HOME/gardens.conf ]; then
    echo "Misconfigured GARDENS_HOME? Missing: $GARDENS_HOME/gardens.conf"
    exit 1
fi

# Read in our configuration
. $GARDENS_HOME/gardens.conf

# Let's blow that file descriptor limit wide open baby!
ulimit -n 4096

DAEMON=$GARDENS_HOME/bin/respawn-gardens
PIDFILE=/var/run/respawn-gardens.pid

# See how we were called
case "$1" in
  start)
        # Make sure respawn is not currently running
	if [ -f $PIDFILE ]; then
	    echo "respawn-gardens appears to be already running."
            echo "Run '$0 stop' to stop it first."
	    exit 1
	fi
        # Make sure there are no hung Gardens server processes
        RPIDS=`ps auxww | grep ToyBoxServer | grep java | \
            awk '{ print $2 }' | sort -n | head -1`
        if [ ! -z "$RPIDS" ]; then
            echo "WARNING: A Gardens server process is currently running."
            echo "If it has failed and you wish to forcibly restart it, please"
            echo "execute the following commands:"
            echo ""
            echo "% kill -QUIT $RPIDS"
            echo "% kill -KILL $RPIDS"
            echo ""
            echo "And then rerun this script."
            exit -1
        fi
        # Go ahead and start things up
        echo -n "Starting $DAEMON: "
        su - $GARDENS_USER -c "$DAEMON" &
	echo $! > $PIDFILE
        echo "started."
        ;;

  stop)
	if [ ! -f $PIDFILE ]; then
	    echo "No $PIDFILE exists. Is respawn-gardens running?"
	    exit 1
	fi
        echo -n "Shutting down gardens, "
        $GARDENS_HOME/bin/reboot-gardens
        echo -n "respawn: "
        kill `cat $PIDFILE`
        echo "stopped."
        rm -f $PIDFILE
        ;;

  restart)
        echo "Restarting gardens server..."
        $GARDENS_HOME/bin/reboot-gardens
        ;;

  *)
        echo "Usage: $0 {start|stop|restart}"
        exit 1
esac

exit 0
